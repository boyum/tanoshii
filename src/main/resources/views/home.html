<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: layout(${title}, ~{::main})}">
<head>
    <title>Tanoshii</title>
</head>
<body>
<main class="container home">
    <header class="header">
        <h1>Tanoshii</h1>
        <p class="tagline">Learn Japanese, one sentence at a time</p>
        <p class="tagline-jp">Ê•Ω„Åó„ÅèÊó•Êú¨Ë™û„ÇíÂ≠¶„Åº„ÅÜ</p>
    </header>

    <section class="start-section">
        <h2><span class="icon">üìñ</span> Reading Practice</h2>

        <form id="difficulty-form" class="difficulty-form">
            <div class="difficulty-options">
                <label class="difficulty-option">
                    <input type="radio" name="difficulty" value="easy" checked>
                    <div class="difficulty-card">
                        <span class="difficulty-icon">üå∏</span>
                        <div class="difficulty-info">
                            <span class="difficulty-name">Easy</span>
                            <span class="difficulty-desc">10 short sentences</span>
                        </div>
                    </div>
                </label>

                <label class="difficulty-option">
                    <input type="radio" name="difficulty" value="medium">
                    <div class="difficulty-card">
                        <span class="difficulty-icon">üéã</span>
                        <div class="difficulty-info">
                            <span class="difficulty-name">Medium</span>
                            <span class="difficulty-desc">5 sentences + 5 stories</span>
                        </div>
                    </div>
                </label>

                <label class="difficulty-option">
                    <input type="radio" name="difficulty" value="hard">
                    <div class="difficulty-card">
                        <span class="difficulty-icon">üèØ</span>
                        <div class="difficulty-info">
                            <span class="difficulty-name">Hard</span>
                            <span class="difficulty-desc">10 stories</span>
                        </div>
                    </div>
                </label>
            </div>

            <button type="button" class="btn btn-primary btn-large" onclick="showTopicSelection()">
                Choose Topic & Start
            </button>
        </form>
    </section>

    <!-- Previous sessions -->
    <section class="previous-sessions" th:if="${not #lists.isEmpty(recentSessions)}">
        <h2><span class="icon">üìö</span> Recent Sessions</h2>
        <div class="sessions-list">
            <a th:each="session : ${recentSessions}"
               th:href="@{/session/{id}(id=${session.id})}"
               class="session-card">
                <div class="session-info">
                    <span class="session-difficulty" th:classappend="${session.difficulty.name().toLowerCase()}">
                        <span th:text="${#strings.capitalize(session.difficulty.name().toLowerCase())}">Easy</span>
                    </span>
                    <span class="session-date" th:text="${#temporals.format(session.createdAt, 'MMM dd, yyyy HH:mm')}">Jan 01, 2024 12:00</span>
                </div>
                <svg class="session-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>
        </div>
    </section>

    <!-- Conversation mode -->
    <section class="conversation-section">
        <h2><span class="icon">üéôÔ∏è</span> Conversation</h2>
        <p class="conversation-desc">Practice speaking Japanese with an AI partner</p>
        <a href="/conversation" class="conversation-link">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/>
            </svg>
            Start Conversation
        </a>
    </section>

    <!-- Topic selection modal -->
    <div id="topic-modal" class="topic-modal">
        <div class="topic-modal-content">
            <h2>Choose a Topic</h2>
            <p class="topic-subtitle">Select a topic for your practice session, or continue without one</p>

            <div id="topic-suggestions" class="topic-suggestions">
                <div class="topic-loading">
                    <div class="topic-spinner"></div>
                    <p id="topic-loading-text">Generating topic suggestions...</p>
                </div>
            </div>

            <div class="topic-custom">
                <label for="custom-topic">Or enter your own topic:</label>
                <input
                    type="text"
                    id="custom-topic"
                    placeholder="e.g., Cooking, Sports, Technology"
                    maxlength="50"
                />
            </div>

            <div class="topic-actions">
                <button type="button" class="btn btn-secondary" onclick="skipTopic()">
                    Skip Topic
                </button>
                <button type="button" class="btn btn-primary" onclick="startWithTopic()">
                    Start Session
                </button>
            </div>
        </div>
    </div>

    <!-- Splash screen overlay -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-spinner"></div>
            <p class="splash-text" id="splash-text">Preparing sentences...</p>
            <p class="splash-hint" id="splash-hint">Relax and have a cup of tea</p>
        </div>
    </div>

    <script>
        const loadingHints = [
            "Finding the best words...",
            "Consulting with sensei...",
            "Folding origami while you wait...",
            "Practicing calligraphy...",
            "Counting sakura blossoms...",
            "Meditating on kanji...",
            "Gathering wisdom from the mountain...",
            "Brewing matcha tea...",
            "Waiting for the rice noodles to cook...",
            "Reading manga for inspiration...",
            "Practicing with chopsticks...",
            "Watching sunrise over Fuji...",
            "Listening to the sound of bamboo...",
            "Arranging the zen garden...",
        ];

        const topicLoadingTexts = [
            "Generating topic suggestions...",
            "Brainstorming creative ideas...",
            "Exploring interesting themes...",
            "Thinking outside the box...",
            "Shuffling possibility cards...",
            "Consulting the idea oracle...",
            "Spinning the wheel of topics...",
            "Collecting interesting concepts...",
            "Searching for inspiration...",
            "Mixing up conversation starters...",
            "Dreaming up new themes...",
            "Gathering creative sparks...",
        ];

        let splashTimeout = null;
        let hintInterval = null;
        let topicInterval = null;
        let selectedTopic = null;

        function showTopicSelection() {
            const modal = document.getElementById('topic-modal');
            modal.style.display = 'flex';
            fetchTopicSuggestions();
        }

        function rotateTopicLoadingText() {
            const textEl = document.getElementById('topic-loading-text');
            if (!textEl) return;

            const randomText = topicLoadingTexts[Math.floor(Math.random() * topicLoadingTexts.length)];
            textEl.style.opacity = '0';
            setTimeout(() => {
                textEl.textContent = randomText;
                textEl.style.opacity = '1';
            }, 300);
        }

        async function fetchTopicSuggestions() {
            const container = document.getElementById('topic-suggestions');

            // Start rotating loading texts
            rotateTopicLoadingText();
            topicInterval = setInterval(rotateTopicLoadingText, 2500);

            try {
                const response = await fetch('/api/session/topics');
                const data = await response.json();

                // Stop rotating loading texts
                if (topicInterval) {
                    clearInterval(topicInterval);
                    topicInterval = null;
                }

                // Create topic cards with View Transition API
                const updateContent = () => {
                    container.innerHTML = data.topics.map(topic =>
                        `<button type="button" class="topic-card" onclick="selectTopic('${topic}')">
                            ${topic}
                        </button>`
                    ).join('');
                };

                // Use View Transitions API if supported
                if (document.startViewTransition) {
                    document.startViewTransition(updateContent);
                } else {
                    updateContent();
                }
            } catch (error) {
                console.error('Failed to fetch topics:', error);

                // Stop rotating loading texts
                if (topicInterval) {
                    clearInterval(topicInterval);
                    topicInterval = null;
                }

                const updateError = () => {
                    container.innerHTML = '<p class="topic-error">Failed to load topics. You can enter your own below.</p>';
                };

                // Use View Transitions API if supported
                if (document.startViewTransition) {
                    document.startViewTransition(updateError);
                } else {
                    updateError();
                }
            }
        }

        function selectTopic(topic) {
            // Deselect all cards
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Select clicked card
            event.target.classList.add('selected');
            selectedTopic = topic;

            // Clear custom input if a suggestion was selected
            document.getElementById('custom-topic').value = '';
        }

        function skipTopic() {
            selectedTopic = null;
            document.getElementById('custom-topic').value = '';
            startSession();
        }

        function startWithTopic() {
            // Use custom topic if entered, otherwise use selected suggestion
            const customTopic = document.getElementById('custom-topic').value.trim();
            selectedTopic = customTopic || selectedTopic;
            startSession();
        }

        function startSession() {
            // Get selected difficulty
            const difficulty = document.querySelector('input[name="difficulty"]:checked')?.value || 'easy';

            // Build form data
            const formData = new URLSearchParams();
            formData.append('difficulty', difficulty);
            if (selectedTopic) {
                formData.append('topic', selectedTopic);
            }

            // Close modal
            document.getElementById('topic-modal').style.display = 'none';

            // Show splash screen
            showSplash();

            // Submit to server
            fetch('/api/session/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            })
            .then(response => {
                const redirectUrl = response.headers.get('HX-Redirect');
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            })
            .catch(error => {
                console.error('Failed to start session:', error);
                alert('Failed to start session. Please try again.');
                document.getElementById('splash-screen').classList.remove('visible');
            });
        }

        function showSplash() {
            // Only show splash after 200ms delay
            splashTimeout = setTimeout(() => {
                const showSplashScreen = () => {
                    document.getElementById('splash-screen').classList.add('visible');
                    rotateHints();
                    hintInterval = setInterval(rotateHints, 3000);
                };

                // Use View Transitions API if supported
                if (document.startViewTransition) {
                    document.startViewTransition(showSplashScreen);
                } else {
                    showSplashScreen();
                }
            }, 200);
        }

        function rotateHints() {
            const hintEl = document.getElementById('splash-hint');
            const randomHint = loadingHints[Math.floor(Math.random() * loadingHints.length)];
            hintEl.style.opacity = '0';
            setTimeout(() => {
                hintEl.textContent = randomHint;
                hintEl.style.opacity = '1';
            }, 300);
        }

        // Clean up if page navigates away
        window.addEventListener('beforeunload', () => {
            if (splashTimeout) clearTimeout(splashTimeout);
            if (hintInterval) clearInterval(hintInterval);
        });
    </script>
</main>
</body>
</html>
